var SuperBattleship=function(a){var b=function(a){for(var b="",c="ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789",d=0;d<a;d++)b+=c.charAt(Math.floor(Math.random()*c.length));return b},c={fleet:[{name:"Carrier",size:5},{name:"Battleship",size:4},{name:"Cruiser",size:3},{name:"Submarine",size:3},{name:"Destroyer",size:2}],boardSize:50,missAge:10,turnLimit:1e3,rotateMissLimit:3,rearViewDistance:2};if(null!=a)for(var d in a)c[d]=a[d];var e=SBConstants.REGISTERING_PLAYERS,f=null,g=null,h=b(10),i={},j=[],k=[],l=[],m=0,n=this,o=function(a){if(n.status!=SBConstants.FINISHED){a.event_type==SBConstants.GAME_OVER_EVENT&&(n.status=SBConstants.FINISHED),a.game=n;var b=i[a.event_type];if(null!=b)for(var c=0;c<b.length;c++)b[c](a);if(b=i[SBConstants.ALL_EVENTS],null!=b)for(var c=0;c<b.length;c++)b[c](a)}},p=function(){var a=0;c.fleet.forEach(function(b){b.size>a&&(a=b.size)});var b=Math.floor(a/2+.5),d=c.boardSize/2,e={left:b,right:Math.floor(d-b),top:0,bottom:c.boardSize-1},h={left:Math.ceil(d+b),right:c.boardSize-1-b,top:0,bottom:c.boardSize-1},i=function(a,b,c,d){for(var e=[SBConstants.NORTH,SBConstants.SOUTH,SBConstants.EAST,SBConstants.WEST],f=!1;!f;){var g=Math.floor(Math.random()*(a.right-a.left+1))+a.left,h=Math.floor(Math.random()*(a.bottom-a.top+1))+a.top,i=e[Math.floor(4*Math.random())],j=SBConstants.dxByDir(i),k=SBConstants.dyByDir(i);a:{for(var l=0;l<d;l++){var m=g+j*l,n=h+k*l;if(m=t(m),n=u(n),m<a.left||m>a.right||n<a.top||n>a.bottom||null!=q(b,c,m,n))break a}f=!0}}return{x:g,y:h,direction:i}};c.fleet.forEach(function(a){var b=i(e,f,k,a.size);k.push(new Ship(a.name,a.size,b,f,n)),b=i(h,g,l,a.size),l.push(new Ship(a.name,a.size,b,g,n))})},q=function(a,b,c,d){for(var e=0;e<b.length;e++){var f=b[e];if(f.occupies(a,c,d))return f}return null},r=function(a,b,c,d){for(var e=0;e<b.length;e++){var f=b[e];if(f.canSee(a,c,d))return!0}return!1},s=function(){if(e!=SBConstants.REGISTERING_PLAYERS&&e!=SBConstants.FINISHED){if(e=e==SBConstants.PLAYER_ONE?SBConstants.PLAYER_TWO:SBConstants.PLAYER_ONE,m++,m==c.turnLimit)return void o(new GameOverEvent(SBConstants.DRAW));var a=[];j.forEach(function(b){b.expiration>=m&&a.push(b)}),j=a,o(new TurnChangeEvent(e))}},t=function(a){return(a%c.boardSize+c.boardSize)%c.boardSize},u=function(a){return(a%c.boardSize+c.boardSize)%c.boardSize},v=function(a,b,c){if(e==SBConstants.REGISTERING_PLAYERS||e==SBConstants.FINISHED)return!1;if(a!=f&&a!=g)return!1;if(a==f&&e!=SBConstants.PLAYER_ONE)return!1;if(a==g&&e!=SBConstants.PLAYER_TWO)return!1;var d=b.getPosition(a);if(null==d)return!1;if(b.getStatus()==SBConstants.DEAD)return!1;var i=d.x,j=d.y,k=d.x,l=d.y,m=0;switch(c<0&&(m=b.getSize()-1),d.direction){case SBConstants.NORTH:l-=c+m,j-=c;break;case SBConstants.SOUTH:l+=c-m,j+=c;break;case SBConstants.EAST:k+=c-m,i+=c;break;case SBConstants.WEST:k-=c+m,i-=c}k=t(k),l=u(l);var o=n.queryLocation(a,k,l);return"empty"==o.type&&(i=t(i),j=u(j),b.setShipLocation(h,i,j),s(),!0)},w=function(a,b,d){if(e==SBConstants.REGISTERING_PLAYERS||e==SBConstants.FINISHED)return!1;if(a!=f&&a!=g)return!1;if(a==f&&e!=SBConstants.PLAYER_ONE)return!1;if(a==g&&e!=SBConstants.PLAYER_TWO)return!1;var i=b.getPosition(a);if(null==i)return!1;for(var j=function(){var a=function(){var a=p,b=-q;p=b,q=a};switch(i.direction){case SBConstants.WEST:a();case SBConstants.SOUTH:a();case SBConstants.EAST:a()}p+=i.x,q+=i.y,p=t(p),q=u(q)},k=b.getSize(),l=0,m=0;m<k;m++)for(var o=1;o<k;o++){var p=d?-o:o,q=m;j();var r=n.queryLocation(a,p,q);if("empty"!=r.type){if("miss"!=r.type||0==m)return!1;if(l+=1,l>c.rotateMissLimit)return!1}}var v=d?SBConstants.nextDirCW(i.direction):SBConstants.nextDirCCW(i.direction);return b.setShipDirection(h,v),s(),!0};this.isKey=function(a){return a==h},this.isPlayerOneKey=function(a){return a==f},this.isPlayerTwoKey=function(a){return a==f},this.getStatus=function(){return e},this.getBoardSize=function(){return c.boardSize},this.normalizeX=function(a){return t(a)},this.normalizeY=function(a){return u(a)},this.getTurnCount=function(){return m},this.getTurnLimit=function(){return c.turnLimit},this.getRearViewDistance=function(){return c.rearViewDistance},this.registerPlayerOne=function(){return null==f&&(f=b(10))},this.registerPlayerTwo=function(){return null==g&&(g=b(10))},this.startGame=function(){return e==SBConstants.REGISTERING_PLAYERS&&null!=f&&null!=g&&(p(),e=SBConstants.PLAYER_ONE,o(new TurnChangeEvent(SBConstants.PLAYER_ONE)),!0)},this.registerEventHandler=function(a,b){null==i[a]&&(i[a]=new Array),i[a].push(b)},this.getPlayerOneFleet=function(){return k.slice(0)},this.getPlayerTwoFleet=function(){return l.slice(0)},this.getFleetByKey=function(a){return a==f?this.getPlayerOneFleet():a==g?this.getPlayerTwoFleet():null},this.shootAt=function(a,b,d){if(e==SBConstants.REGISTERING_PLAYERS||e==SBConstants.FINISHED)return!1;if(a!=f&&a!=g)return!1;if(a==f&&e!=SBConstants.PLAYER_ONE)return!1;if(a==g&&e!=SBConstants.PLAYER_TWO)return!1;b=t(b),d=u(d);var i=q(f,k,b,d);if(null==i&&(i=q(g,l,b,d)),null!=i){if(i.registerHit(h,b,d),o(new HitEvent(i,b,d)),i.getStatus()==SBConstants.DEAD)if(o(new ShipSunkEvent(i)),i.getOwner()==SBConstants.PLAYER_ONE){var m=k.find(function(a){return a.getStatus()==SBConstants.ALIVE});void 0==m&&o(new GameOverEvent(SBConstants.PLAYER_TWO))}else m=l.find(function(a){return a.getStatus()==SBConstants.ALIVE}),void 0==m&&o(new GameOverEvent(SBConstants.PLAYER_ONE))}else{var n=null;j.forEach(function(a){a.x==b&&a.y==d&&(a.expiration+=c.missAge,n=a)}),null==n&&(n={x:b,y:d,expiration:this.getTurnCount()+c.missAge},j.push(n)),o(new MissEvent(n))}return s(),!0},this.moveShipForward=function(a,b){return v(a,b,1)},this.moveShipBackward=function(a,b){return v(a,b,-1)},this.rotateShipCW=function(a,b){return w(a,b,!0)},this.rotateShipCCW=function(a,b){return w(a,b,!1)},this.getShipByName=function(a,b){return a==f?k.find(function(a){return a.getName()==b}):a==g?l.find(function(a){return a.getName()==b}):null},this.queryLocation=function(a,b,c){var d=null,e=!1,i=null;if(b=t(b),c=u(c),j.forEach(function(a){a.x==b&&a.y==c&&(i=a)}),null!=i)d={type:"miss",expires:i.expiration},e=!0;else{var m=q(f,k,b,c),n="p1";if(null==m&&(m=q(g,l,b,c),n="p2"),null!=m){var o=m.lookupSegmentIndex(h,b,c),p=m.getSegmentState(h,o);d={type:n,ship:m,segment:o,state:p},e=m.getStatus()==SBConstants.DEAD}else d={type:"empty"}}return e||a==f&&r(a,k,b,c)||a==g&&r(a,l,b,c)?d:{type:"invisible"}}},TurnChangeEvent=function(a){this.event_type=SBConstants.TURN_CHANGE_EVENT,this.who=a},HitEvent=function(a,b,c){this.event_type=SBConstants.HIT_EVENT,this.ship=a,this.x=b,this.y=c},MissEvent=function(a){this.event_type=SBConstants.MISS_EVENT,this.x=a.x,this.y=a.y,this.expiration=a.expiration},ShipSunkEvent=function(a){this.event_type=SBConstants.SHIP_SUNK_EVENT,this.ship=a},GameOverEvent=function(a){this.event_type=SBConstants.GAME_OVER_EVENT,this.winner=a},Ship=function(a,b,c,d,e){for(var f=[],g=0;g<b;g++)f[g]=SBConstants.OK;this.lookupSegmentIndex=function(a,d,f){if(e.isKey(a)){switch(d=e.normalizeX(d),f=e.normalizeY(f),c.direction){case SBConstants.NORTH:if(d!=c.x)return-1;f<c.y&&(f+=e.getBoardSize());var g=f-c.y;break;case SBConstants.SOUTH:if(d!=c.x)return-1;f>c.y&&(f-=e.getBoardSize());var g=c.y-f;break;case SBConstants.WEST:if(f!=c.y)return-1;d<c.x&&(d+=e.getBoardSize());var g=d-c.x;break;case SBConstants.EAST:if(f!=c.y)return-1;d>c.x&&(d-=e.getBoardSize());var g=c.x-d}return g>=b||g<0?-1:g}},this.setShipLocation=function(a,b,d){e.isKey(a)&&(c.x=e.normalizeX(b),c.y=e.normalizeY(d))},this.setShipDirection=function(a,b){e.isKey(a)&&(c.direction=b)},this.registerHit=function(a,b,c){if(e.isKey(a)){var d=this.lookupSegmentIndex(a,b,c);d!=-1&&(f[d]=SBConstants.BURNT)}},this.getSegmentState=function(a,b){if(e.isKey(a))return f[b]},this.getPosition=function(a){return a==d||this.getStatus()==SBConstants.DEAD?c:null},this.occupies=function(a,f,g){if(d==a){f=e.normalizeX(f),g=e.normalizeY(g);for(var h=0;h<b;h++){var i=e.normalizeX(c.x+h*SBConstants.dxByDir(c.direction)),j=e.normalizeY(c.y+h*SBConstants.dyByDir(c.direction));if(i==f&&j==g)return!0}return!1}},this.canSee=function(a,f,g){if(d==a){f=e.normalizeX(f),g=e.normalizeY(g);var h=function(){var a=-f,b=g;f=b,g=a};switch(f-=c.x,g-=c.y,c.direction){case SBConstants.WEST:h();case SBConstants.SOUTH:h();case SBConstants.EAST:h()}var i=-1,j=-1,k=-1,l=-1;return g<0?i=-g:g>b-1?j=g-b+1:(i=0,j=0),f<0?k=-f:f>0?l=f:(k=0,l=0),i==-1?i=e.getBoardSize()-j-b+1:j==-1&&(j=e.getBoardSize()-i-b+1),l==-1?l=e.getBoardSize()-k:k==-1&&(k=e.getBoardSize()-l),i<=b&&(k<=b||l<=b)||j<=e.getRearViewDistance()&&(k<=b||l<=b)}},this.getName=function(){return a},this.getSize=function(){return b},this.getOwner=function(){return e.isPlayerOneKey(d)?SBConstants.PLAYER_ONE:e.isPlayerTwoKey(d)?SBConstants.PLAYER_TWO:null},this.isMine=function(a){return d==a},this.getStatus=function(){return void 0==f.find(function(a){return a==SBConstants.OK})?SBConstants.DEAD:SBConstants.ALIVE}};